name: Sync Grafana Dashboards

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.json'
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  sync-dashboards:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup environment
      run: |
        echo "üéØ Starting Grafana Dashboard Sync"
        echo "Repository: ${{ github.repository }}"
        echo "Triggered by: ${{ github.actor }}"
        echo "Commit: ${{ github.sha }}"
    
    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y curl jq
    
    - name: Validate JSON files
      run: |
        echo "üîç Validating JSON files..."
        
        # Find all JSON files
        JSON_FILES=$(find . -name "*.json" -not -path "./.github/*" -not -path "./node_modules/*" | head -20)
        
        if [ -z "$JSON_FILES" ]; then
          echo "‚ÑπÔ∏è No JSON files found"
          exit 0
        fi
        
        echo "Found $(echo "$JSON_FILES" | wc -l) JSON file(s)"
        
        # Validate each file
        for file in $JSON_FILES; do
          echo "Checking: $file"
          if jq empty "$file" 2>/dev/null; then
            echo "  ‚úÖ Valid JSON"
          else
            echo "  ‚ùå Invalid JSON"
            exit 1
          fi
        done
        
        echo "‚úÖ All JSON files are valid"
    
    - name: Sync dashboards to Grafana
      env:
        GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
        GRAFANA_TOKEN: ${{ secrets.GRAFANA_API_TOKEN }}
      run: |
        echo "üöÄ Starting Grafana sync..."
        
        # Find JSON files
        JSON_FILES=$(find . -name "*.json" -not -path "./.github/*" -not -path "./node_modules/*")
        
        if [ -z "$JSON_FILES" ]; then
          echo "‚ÑπÔ∏è No JSON files to sync"
          exit 0
        fi
        
        SUCCESS=0
        FAILED=0
        
        for file in $JSON_FILES; do
          echo ""
          echo "üì§ Processing: $(basename "$file")"
          
          # Get dashboard title
          TITLE=$(jq -r '.dashboard.title // .title // "Untitled Dashboard"' "$file" 2>/dev/null || echo "Unknown")
          echo "  Title: $TITLE"
          
          # Create temporary file for payload
          TEMP_FILE=$(mktemp)
          
          # Prepare the payload
          if jq -e '.dashboard' "$file" > /dev/null 2>&1; then
            # File already has dashboard wrapper
            jq '. + {overwrite: true, message: "Updated via GitHub Actions"}' "$file" > "$TEMP_FILE"
          else
            # Wrap in dashboard object
            jq '{dashboard: ., overwrite: true, message: "Updated via GitHub Actions"}' "$file" > "$TEMP_FILE"
          fi
          
          # Send to Grafana
          echo "  Sending to Grafana..."
          HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $GRAFANA_TOKEN" \
            -H "Content-Type: application/json" \
            --data-binary @"$TEMP_FILE" \
            "$GRAFANA_URL/api/dashboards/db")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "  ‚úÖ Success!"
            SUCCESS=$((SUCCESS + 1))
          else
            ERROR_MSG=$(jq -r '.message // .error // "Unknown error"' /tmp/response.json 2>/dev/null || echo "HTTP $HTTP_CODE")
            echo "  ‚ùå Failed: $ERROR_MSG"
            FAILED=$((FAILED + 1))
          fi
          
          # Cleanup
          rm -f "$TEMP_FILE" /tmp/response.json
        done
        
        echo ""
        echo "üìä Summary:"
        echo "  ‚úÖ Successfully synced: $SUCCESS"
        echo "  ‚ùå Failed: $FAILED"
        echo ""
        
        if [ $FAILED -gt 0 ]; then
          echo "‚ùå Some dashboards failed to sync"
          exit 1
        else
          echo "üéâ All dashboards synced successfully!"
        fi
