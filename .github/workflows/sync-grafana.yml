name: Sync Grafana

on:
  push:
    branches: [ main ]
    paths: [ '**.json' ]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup
      run: sudo apt-get update && sudo apt-get install -y curl jq
    
    - name: Test Connection
      env:
        URL: ${{ secrets.GRAFANA_URL }}
        TOKEN: ${{ secrets.GRAFANA_API_TOKEN }}
      run: |
        echo "Testing Grafana at: $URL"
        if curl -s -H "Authorization: Bearer $TOKEN" "$URL/api/health" | grep -q "ok"; then
          echo "✅ Connected"
        else
          echo "❌ Cannot connect"
          exit 1
        fi
    
    - name: Sync Dashboards
      env:
        URL: ${{ secrets.GRAFANA_URL }}
        TOKEN: ${{ secrets.GRAFANA_API_TOKEN }}
      run: |
        for file in *.json; do
          echo "Syncing $file"
          curl -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            --data-binary @$file \
            "$URL/api/dashboards/db" && echo "✅ Done" || echo "❌ Failed"
        done
