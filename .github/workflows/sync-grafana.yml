name: Sync Grafana Dashboards

on:
  push:
    branches: [ main ]
    paths: [ '**.json' ]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install tools
      run: sudo apt-get update && sudo apt-get install -y curl jq
      
    - name: Sync Dashboards
      env:
        GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
        GRAFANA_TOKEN: ${{ secrets.GRAFANA_API_TOKEN }}
      run: |
        for file in *.json; do
          echo "Syncing $file"
          curl -X POST \
            -H "Authorization: Bearer $GRAFANA_TOKEN" \
            -H "Content-Type: application/json" \
            --data-binary @$file \
            "$GRAFANA_URL/api/dashboards/db" || true
          echo ""
        done
